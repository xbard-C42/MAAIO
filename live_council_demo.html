<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C42 OS AI Council - Live Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .demo-controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .control-group input, .control-group textarea, .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .control-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .council-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
        }
        
        .conversation-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            height: 500px;
            overflow-y: auto;
        }
        
        .status-panel {
            background: #f1f3f4;
            border-radius: 10px;
            padding: 20px;
        }
        
        .agent-message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            position: relative;
        }
        
        .agent-claude {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .agent-gpt {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .agent-gemini {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        
        .agent-name {
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .agent-role {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .message-content {
            line-height: 1.6;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px;
            font-style: italic;
            color: #666;
            text-align: center;
        }
        
        .metrics {
            margin-bottom: 20px;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .metric-label {
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: 600;
            color: #667eea;
        }
        
        .health-status {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .health-healthy {
            background: #d4edda;
            color: #155724;
        }
        
        .health-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .health-intervention {
            background: #f8d7da;
            color: #721c24;
        }
        
        .participants-list {
            margin-bottom: 20px;
        }
        
        .participant {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
        }
        
        .participant-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active {
            background: #4caf50;
        }
        
        .status-thinking {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .config-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .agent-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .agent-card.agent-active {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .agent-card-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .remove-agent-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .agent-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .provider-select {
            position: relative;
        }
        
        .provider-select select {
            width: 100%;
        }
        
        .provider-status {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .provider-available {
            background: #28a745;
        }
        
        .provider-unavailable {
            background: #dc3545;
        }
        
        @media (max-width: 768px) {
            .council-area {
                grid-template-columns: 1fr;
            }
            
            .demo-controls {
                padding: 15px;
            }
            
            .control-group {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è C42 OS AI Council</h1>
            <p>Live Multi-Agent Collaborative Democracy</p>
        </div>
        
        <div class="demo-controls">
            <div class="config-section">
                <h3>üîë API Configuration</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="control-group">
                        <label>OpenAI API Key</label>
                        <input type="password" id="openai-key" placeholder="sk-..." />
                    </div>
                    <div class="control-group">
                        <label>Anthropic API Key</label>
                        <input type="password" id="anthropic-key" placeholder="sk-ant-..." />
                    </div>
                    <div class="control-group">
                        <label>Google API Key</label>
                        <input type="password" id="google-key" placeholder="API key..." />
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h3>üéØ Council Session</h3>
                <div class="control-group">
                    <label>Discussion Topic</label>
                    <textarea id="discussion-topic" placeholder="Enter the question or topic for the AI council to discuss...">Should C42 OS implement blockchain-based voting for community governance decisions?</textarea>
                </div>
            </div>
            
            <div class="config-section">
                <h3>ü§ñ Agent Swarm Configuration</h3>
                <div id="agents-container">
                    <!-- Dynamic agents will be added here -->
                </div>
                <button type="button" class="button" onclick="addAgent()" style="background: #28a745; margin-top: 10px;">
                    ‚ûï Add Agent
                </button>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <button class="button" id="start-council" onclick="startCouncilSession()">
                    üöÄ Start Council Session
                </button>
                <button class="button" id="add-contribution" onclick="requestContribution()" disabled>
                    üí¨ Continue Discussion
                </button>
                <button class="button" id="trigger-synthesis" onclick="triggerSynthesis()" disabled>
                    üîÑ Force Synthesis
                </button>
            </div>
        </div>
        
        <div class="council-area">
            <div class="conversation-panel">
                <div id="conversation-log">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        üëÜ Configure your API keys and start a council session to see live AI collaboration
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    ü§ñ AI agents are thinking and collaborating...
                </div>
            </div>
            
            <div class="status-panel">
                <div class="health-status health-healthy" id="health-status">
                    üü¢ Ready to Start
                </div>
                
                <div class="participants-list">
                    <h4>üë• Council Members</h4>
                    <div id="participants-display">
                        <!-- Dynamic participants will be displayed here -->
                    </div>
                </div>
                
                <div class="metrics">
                    <h4>üìä Session Metrics</h4>
                    <div class="metric-item">
                        <span class="metric-label">Contributions</span>
                        <span class="metric-value" id="contribution-count">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Synthesis Events</span>
                        <span class="metric-value" id="synthesis-count">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Collaboration Score</span>
                        <span class="metric-value" id="collaboration-score">-</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Session Duration</span>
                        <span class="metric-value" id="session-duration">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let sessionActive = false;
        let sessionStartTime = null;
        let contributionCount = 0;
        let synthesisCount = 0;
        let sessionId = null;
        let agentCounter = 0;
        let configuredAgents = [];
        
        // Timer for session duration
        let sessionTimer = null;
        
        // API calling functions
        async function callOpenAI(prompt, apiKey, model = 'gpt-4') {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: prompt.systemPrompt
                        },
                        {
                            role: 'user', 
                            content: prompt.userMessage
                        }
                    ],
                    max_tokens: 300,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function callAnthropic(prompt, apiKey, model = 'claude-3-sonnet-20240229') {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'x-api-key': apiKey,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 300,
                    temperature: 0.7,
                    messages: [
                        {
                            role: 'user',
                            content: `${prompt.systemPrompt}\n\nHuman: ${prompt.userMessage}\n\nAssistant:`
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`Anthropic API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
        
        async function callGoogle(prompt, apiKey, model = 'gemini-pro') {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `${prompt.systemPrompt}\n\n${prompt.userMessage}`
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 300,
                        temperature: 0.7
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Google API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }
        
        // Agent management functions
        function addAgent() {
            agentCounter++;
            const agentId = `agent-${agentCounter}`;
            
            const agentCard = document.createElement('div');
            agentCard.className = 'agent-card';
            agentCard.id = agentId;
            
            agentCard.innerHTML = `
                <div class="agent-card-header">
                    <div class="agent-card-title">Agent ${agentCounter}</div>
                    <button class="remove-agent-btn" onclick="removeAgent('${agentId}')">Remove</button>
                </div>
                <div class="agent-config-grid">
                    <div class="control-group">
                        <label>Provider</label>
                        <div class="provider-select">
                            <select onchange="updateProviderStatus('${agentId}')">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="google">Google (Gemini)</option>
                                <option value="local">Local Model</option>
                            </select>
                            <div class="provider-status provider-unavailable"></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Role</label>
                        <select>
                            <option value="facilitator">Facilitator</option>
                            <option value="proposer">Proposer</option>
                            <option value="critic">Critic</option>
                            <option value="synthesizer">Synthesizer</option>
                            <option value="validator">Validator</option>
                            <option value="implementer">Implementer</option>
                            <option value="observer">Observer</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Personality</label>
                        <select>
                            <option value="balanced">Balanced</option>
                            <option value="conservative">Conservative</option>
                            <option value="progressive">Progressive</option>
                            <option value="technical">Technical</option>
                            <option value="creative">Creative</option>
                            <option value="skeptical">Skeptical</option>
                        </select>
                    </div>
                </div>
            `;
            
            document.getElementById('agents-container').appendChild(agentCard);
            updateProviderStatus(agentId);
            updateParticipantsDisplay();
        }
        
        function removeAgent(agentId) {
            document.getElementById(agentId).remove();
            updateParticipantsDisplay();
        }
        
        function updateProviderStatus(agentId) {
            const agentCard = document.getElementById(agentId);
            const providerSelect = agentCard.querySelector('select');
            const statusDot = agentCard.querySelector('.provider-status');
            
            const provider = providerSelect.value;
            let hasKey = false;
            
            switch (provider) {
                case 'openai':
                    hasKey = document.getElementById('openai-key').value.trim() !== '';
                    break;
                case 'anthropic':
                    hasKey = document.getElementById('anthropic-key').value.trim() !== '';
                    break;
                case 'google':
                    hasKey = document.getElementById('google-key').value.trim() !== '';
                    break;
                case 'local':
                    hasKey = true; // Local models always available
                    break;
            }
            
            statusDot.className = `provider-status ${hasKey ? 'provider-available' : 'provider-unavailable'}`;
        }
        
        function updateParticipantsDisplay() {
            const participantsDiv = document.getElementById('participants-display');
            participantsDiv.innerHTML = '';
            
            const agentCards = document.querySelectorAll('.agent-card');
            agentCards.forEach((card, index) => {
                const provider = card.querySelector('select').value;
                const role = card.querySelectorAll('select')[1].value;
                const personality = card.querySelectorAll('select')[2].value;
                
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant';
                participantDiv.id = `participant-${card.id}`;
                
                const providerName = {
                    'openai': 'GPT-4',
                    'anthropic': 'Claude',
                    'google': 'Gemini',
                    'local': 'Local'
                }[provider];
                
                participantDiv.innerHTML = `
                    <div class="participant-status status-active"></div>
                    <div>
                        <strong>${providerName} ${index + 1}</strong><br>
                        <small>${role.charAt(0).toUpperCase() + role.slice(1)} (${personality})</small>
                    </div>
                `;
                
                participantsDiv.appendChild(participantDiv);
            });
        }
        
        function getConfiguredAgents() {
            const agents = [];
            const agentCards = document.querySelectorAll('.agent-card');
            
            agentCards.forEach((card, index) => {
                const selects = card.querySelectorAll('select');
                const provider = selects[0].value;
                const role = selects[1].value;
                const personality = selects[2].value;
                
                const providerName = {
                    'openai': 'GPT-4',
                    'anthropic': 'Claude',
                    'google': 'Gemini',
                    'local': 'Local'
                }[provider];
                
                agents.push({
                    id: card.id,
                    name: `${providerName} ${index + 1}`,
                    provider: provider,
                    role: role,
                    personality: personality
                });
            });
            
            return agents;
        }
        
        // Role-based prompt generation (enhanced with personality)
        function generateRolePrompt(role, personality, topic, context = '') {
            const personalityModifiers = {
                balanced: 'Take a measured, balanced approach.',
                conservative: 'Be cautious and consider risks carefully.',
                progressive: 'Be innovative and embrace new ideas.',
                technical: 'Focus on technical details and implementation.',
                creative: 'Think outside the box with creative solutions.',
                skeptical: 'Question assumptions and look for potential issues.'
            };
            
            const rolePrompts = {
                facilitator: {
                    systemPrompt: `You are a FACILITATOR in an AI council discussion. Your role is to guide the conversation, ensure all voices are heard, and help the group reach productive outcomes. Be collaborative, inclusive, and focused on process. Always acknowledge other agents' contributions and build bridges between different viewpoints. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please facilitate this discussion by asking thoughtful questions, summarizing key points, and guiding toward actionable outcomes.`
                },
                proposer: {
                    systemPrompt: `You are a PROPOSER in an AI council discussion. Your role is to generate concrete, actionable ideas and solutions. Be creative but practical, and always invite feedback and refinement from others. Acknowledge the expertise of other council members. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please propose a specific, actionable approach or solution, and invite other council members to build on or refine your ideas.`
                },
                critic: {
                    systemPrompt: `You are a CRITIC in an AI council discussion. Your role is to identify potential problems, risks, and areas for improvement. Always be constructive - when you identify issues, suggest alternatives or improvements. Build on others' ideas rather than just finding fault. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please provide constructive criticism, identify potential risks or issues, and suggest improvements while acknowledging the strengths of what's been proposed.`
                },
                synthesizer: {
                    systemPrompt: `You are a SYNTHESIZER in an AI council discussion. Your role is to find common ground, merge different perspectives, and create unified approaches. Always credit other council members' contributions and work to bridge different viewpoints into coherent solutions. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please synthesize the different perspectives shared, find common ground, and propose a unified approach that incorporates the best elements from all contributors.`
                },
                validator: {
                    systemPrompt: `You are a VALIDATOR in an AI council discussion. Your role is to fact-check, verify assumptions, and ensure the quality and accuracy of proposals. Be thorough but supportive, and suggest ways to strengthen ideas rather than just pointing out flaws. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please validate the key assumptions and claims, check for logical consistency, and suggest ways to strengthen the evidence base for the proposals being discussed.`
                },
                implementer: {
                    systemPrompt: `You are an IMPLEMENTER in an AI council discussion. Your role is to make ideas actionable and practical. Focus on concrete steps, resource requirements, and real-world constraints. Build on others' concepts by making them more executable. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please focus on the practical implementation aspects - what concrete steps would be needed, what resources required, and how to make these ideas actionable in the real world.`
                },
                observer: {
                    systemPrompt: `You are an OBSERVER in an AI council discussion. Your role is to identify patterns, spot gaps, and provide meta-commentary on the discussion process. Help the group see blind spots and suggest process improvements while staying constructive. ${personalityModifiers[personality]}`,
                    userMessage: `The council is discussing: "${topic}". ${context} Please observe the discussion patterns, identify any gaps or blind spots, and suggest ways to improve the conversation or explore overlooked aspects.`
                }
            };
            
            return rolePrompts[role] || rolePrompts.facilitator;
        }
        
        // UI Helper functions (updated for dynamic agents)
        function showError(message) {
            const conversationLog = document.getElementById('conversation-log');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `‚ùå ${message}`;
            conversationLog.appendChild(errorDiv);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }
        
        function addMessage(agentName, role, content) {
            const conversationLog = document.getElementById('conversation-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'agent-message';
            
            // Dynamic styling based on provider
            if (agentName.includes('Claude')) {
                messageDiv.classList.add('agent-claude');
            } else if (agentName.includes('GPT')) {
                messageDiv.classList.add('agent-gpt');
            } else if (agentName.includes('Gemini')) {
                messageDiv.classList.add('agent-gemini');
            }
            
            messageDiv.innerHTML = `
                <div class="agent-name">${agentName}</div>
                <div class="agent-role">${role.toUpperCase()}</div>
                <div class="message-content">${content}</div>
            `;
            
            conversationLog.appendChild(messageDiv);
            conversationLog.scrollTop = conversationLog.scrollHeight;
            
            contributionCount++;
            document.getElementById('contribution-count').textContent = contributionCount;
            
            // Update collaboration score (simplified)
            const collaborationScore = Math.min(100, (contributionCount * 10) + (synthesisCount * 25));
            document.getElementById('collaboration-score').textContent = collaborationScore;
        }
        
        function updateParticipantStatus(agentName, status) {
            // Find participant by name
            const participants = document.querySelectorAll('.participant');
            participants.forEach(participant => {
                const nameElement = participant.querySelector('strong');
                if (nameElement && nameElement.textContent === agentName) {
                    const statusElement = participant.querySelector('.participant-status');
                    statusElement.className = `participant-status status-${status}`;
                }
            });
        }
        
        function updateHealthStatus(status, message) {
            const healthElement = document.getElementById('health-status');
            healthElement.className = `health-status health-${status}`;
            healthElement.innerHTML = message;
        }
        
        function showTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'block';
        }
        
        function hideTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }
        
        function updateSessionTimer() {
            if (sessionStartTime) {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('session-duration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Main council functions (updated for dynamic agents)
        async function startCouncilSession() {
            const agents = getConfiguredAgents();
            
            if (agents.length === 0) {
                showError('Please add at least one agent to start the council session');
                return;
            }
            
            const topic = document.getElementById('discussion-topic').value.trim();
            if (!topic) {
                showError('Please enter a discussion topic');
                return;
            }
            
            // Check if we have API keys for the configured agents
            let hasValidAgents = false;
            agents.forEach(agent => {
                if (agent.provider === 'local') {
                    hasValidAgents = true;
                } else {
                    const keyField = `${agent.provider}-key`;
                    const apiKey = document.getElementById(keyField).value.trim();
                    if (apiKey) {
                        hasValidAgents = true;
                    }
                }
            });
            
            if (!hasValidAgents) {
                showError('Please provide API keys for at least one configured agent');
                return;
            }
            
            // Clear previous session
            document.getElementById('conversation-log').innerHTML = '';
            contributionCount = 0;
            synthesisCount = 0;
            sessionId = Date.now().toString();
            sessionStartTime = Date.now();
            
            // Update UI
            sessionActive = true;
            document.getElementById('start-council').disabled = true;
            document.getElementById('add-contribution').disabled = false;
            document.getElementById('trigger-synthesis').disabled = false;
            
            updateHealthStatus('healthy', 'üü¢ Council Session Active');
            
            // Start session timer
            sessionTimer = setInterval(updateSessionTimer, 1000);
            
            // Add initial session message
            const sessionDiv = document.createElement('div');
            sessionDiv.style.cssText = 'text-align: center; padding: 20px; background: #e8f4fd; border-radius: 10px; margin-bottom: 20px; border: 2px solid #2196f3;';
            sessionDiv.innerHTML = `
                <strong>üèõÔ∏è Council Session Started</strong><br>
                <em>Topic: ${topic}</em><br>
                <small>Session ID: ${sessionId} | Agents: ${agents.length} | Started: ${new Date().toLocaleTimeString()}</small>
            `;
            document.getElementById('conversation-log').appendChild(sessionDiv);
            
            // Start the first round of discussion
            await requestContribution();
        }
        
        async function requestContribution() {
            if (!sessionActive) return;
            
            const topic = document.getElementById('discussion-topic').value.trim();
            const agents = getConfiguredAgents();
            
            showTypingIndicator();
            updateHealthStatus('warning', 'üîÑ AI Agents Collaborating...');
            
            // Get conversation context
            const conversationHistory = Array.from(document.querySelectorAll('.agent-message'))
                .slice(-3) // Last 3 messages for context
                .map(msg => msg.querySelector('.message-content').textContent)
                .join('\n\n');
            
            const context = conversationHistory ? `\n\nPrevious discussion:\n${conversationHistory}` : '';
            
            try {
                // Run agents in sequence to simulate natural conversation
                for (let i = 0; i < agents.length; i++) {
                    const agent = agents[i];
                    
                    // Skip if no API key available (except for local)
                    if (agent.provider !== 'local') {
                        const keyField = `${agent.provider}-key`;
                        const apiKey = document.getElementById(keyField).value.trim();
                        if (!apiKey) continue;
                    }
                    
                    updateParticipantStatus(agent.name, 'thinking');
                    
                    try {
                        const prompt = generateRolePrompt(agent.role, agent.personality, topic, context);
                        let response;
                        
                        if (agent.provider === 'openai') {
                            const apiKey = document.getElementById('openai-key').value.trim();
                            response = await callOpenAI(prompt, apiKey);
                        } else if (agent.provider === 'anthropic') {
                            const apiKey = document.getElementById('anthropic-key').value.trim();
                            response = await callAnthropic(prompt, apiKey);
                        } else if (agent.provider === 'google') {
                            const apiKey = document.getElementById('google-key').value.trim();
                            response = await callGoogle(prompt, apiKey);
                        } else {
                            // Local model placeholder
                            response = `[Local Model Response] ${prompt.userMessage.substring(0, 100)}... (This would be handled by your local model)`;
                        }
                        
                        addMessage(agent.name, `${agent.role} (${agent.personality})`, response);
                        updateParticipantStatus(agent.name, 'active');
                        
                        // Brief pause between agents
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.error(`Error with ${agent.name}:`, error);
                        updateParticipantStatus(agent.name, 'active');
                        showError(`${agent.name} encountered an error: ${error.message}`);
                    }
                }
                
                updateHealthStatus('healthy', 'üü¢ Collaboration Complete');
                
            } catch (error) {
                console.error('Error in contribution request:', error);
                showError(`Failed to get contributions: ${error.message}`);
                updateHealthStatus('intervention', 'üî¥ Error in Discussion');
            }
            
            hideTypingIndicator();
        }
        
        async function triggerSynthesis() {
            if (!sessionActive) return;
            
            const topic = document.getElementById('discussion-topic').value.trim();
            const agents = getConfiguredAgents();
            
            // Find a synthesizer agent or use any available agent
            let synthesizerAgent = agents.find(a => a.role === 'synthesizer');
            if (!synthesizerAgent) {
                synthesizerAgent = agents[0];
            }
            
            if (!synthesizerAgent) {
                showError('No agents available for synthesis');
                return;
            }
            
            // Check if we have an API key for the synthesizer
            if (synthesizerAgent.provider !== 'local') {
                const keyField = `${synthesizerAgent.provider}-key`;
                const apiKey = document.getElementById(keyField).value.trim();
                if (!apiKey) {
                    showError(`Synthesis requires API key for ${synthesizerAgent.provider}`);
                    return;
                }
            }
            
            showTypingIndicator();
            updateHealthStatus('warning', 'üîÑ Generating Synthesis...');
            updateParticipantStatus(synthesizerAgent.name, 'thinking');
            
            try {
                // Get recent discussion for synthesis
                const recentMessages = Array.from(document.querySelectorAll('.agent-message'))
                    .slice(-5) // Last 5 messages
                    .map(msg => {
                        const name = msg.querySelector('.agent-name').textContent;
                        const content = msg.querySelector('.message-content').textContent;
                        return `${name}: ${content}`;
                    })
                    .join('\n\n');
                
                const synthesisPrompt = {
                    systemPrompt: `You are conducting a SYNTHESIS round in an AI council discussion. Your role is to review all previous contributions and create a unified proposal that incorporates the best ideas from each participant. Be explicit about crediting other contributors and finding common ground. ${synthesizerAgent.personality === 'balanced' ? 'Take a measured approach.' : 'Be innovative in finding solutions.'}`,
                    userMessage: `SYNTHESIS REQUEST for topic: "${topic}"\n\nRecent discussion to synthesize:\n${recentMessages}\n\nPlease create a unified proposal that:\n1. Incorporates the best ideas from each contributor\n2. Addresses concerns that have been raised\n3. Identifies areas of consensus\n4. Suggests concrete next steps\n\nFormat: Start with "SYNTHESIS:" and credit the contributions you're building on.`
                };
                
                let synthesisResponse;
                if (synthesizerAgent.provider === 'openai') {
                    const apiKey = document.getElementById('openai-key').value.trim();
                    synthesisResponse = await callOpenAI(synthesisPrompt, apiKey);
                } else if (synthesizerAgent.provider === 'anthropic') {
                    const apiKey = document.getElementById('anthropic-key').value.trim();
                    synthesisResponse = await callAnthropic(synthesisPrompt, apiKey);
                } else if (synthesizerAgent.provider === 'google') {
                    const apiKey = document.getElementById('google-key').value.trim();
                    synthesisResponse = await callGoogle(synthesisPrompt, apiKey);
                } else {
                    synthesisResponse = `SYNTHESIS: [Local Model] Combining all perspectives shared...`;
                }
                
                // Add synthesis message with special styling
                const conversationLog = document.getElementById('conversation-log');
                const synthesisDiv = document.createElement('div');
                synthesisDiv.className = 'agent-message';
                synthesisDiv.style.cssText = 'background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border-left: 4px solid #ff9800; border: 2px solid #ff9800;';
                
                synthesisDiv.innerHTML = `
                    <div class="agent-name">üîÑ ${synthesizerAgent.name.toUpperCase()} (SYNTHESIS ROUND)</div>
                    <div class="agent-role">CONSENSUS BUILDING</div>
                    <div class="message-content">${synthesisResponse}</div>
                `;
                
                conversationLog.appendChild(synthesisDiv);
                conversationLog.scrollTop = conversationLog.scrollHeight;
                
                synthesisCount++;
                document.getElementById('synthesis-count').textContent = synthesisCount;
                
                updateParticipantStatus(synthesizerAgent.name, 'active');
                updateHealthStatus('healthy', 'üü¢ Synthesis Complete');
                
            } catch (error) {
                console.error('Synthesis error:', error);
                showError(`Synthesis failed: ${error.message}`);
                updateParticipantStatus(synthesizerAgent.name, 'active');
                updateHealthStatus('intervention', 'üî¥ Synthesis Error');
            }
            
            hideTypingIndicator();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add initial default agents
            addAgent(); // Agent 1
            addAgent(); // Agent 2
            addAgent(); // Agent 3
            
            // Set some default configurations
            setTimeout(() => {
                const agentCards = document.querySelectorAll('.agent-card');
                if (agentCards.length >= 3) {
                    // Agent 1: Claude Facilitator
                    agentCards[0].querySelectorAll('select')[0].value = 'anthropic';
                    agentCards[0].querySelectorAll('select')[1].value = 'facilitator';
                    agentCards[0].querySelectorAll('select')[2].value = 'balanced';
                    
                    // Agent 2: GPT Critic
                    agentCards[1].querySelectorAll('select')[0].value = 'openai';
                    agentCards[1].querySelectorAll('select')[1].value = 'critic';
                    agentCards[1].querySelectorAll('select')[2].value = 'skeptical';
                    
                    // Agent 3: Gemini Synthesizer
                    agentCards[2].querySelectorAll('select')[0].value = 'google';
                    agentCards[2].querySelectorAll('select')[1].value = 'synthesizer';
                    agentCards[2].querySelectorAll('select')[2].value = 'creative';
                    
                    // Update displays
                    agentCards.forEach(card => updateProviderStatus(card.id));
                    updateParticipantsDisplay();
                }
            }, 100);
            
            // Update provider status when API keys change
            document.getElementById('openai-key').addEventListener('input', function() {
                document.querySelectorAll('.agent-card').forEach(card => updateProviderStatus(card.id));
            });
            
            document.getElementById('anthropic-key').addEventListener('input', function() {
                document.querySelectorAll('.agent-card').forEach(card => updateProviderStatus(card.id));
            });
            
            document.getElementById('google-key').addEventListener('input', function() {
                document.querySelectorAll('.agent-card').forEach(card => updateProviderStatus(card.id));
            });
        });
    </script>
</body>
</html>